---
title: "Exercise 4"
author: "Jon Guler"
date: "2024-05-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Initialization

```{r Task 0.0}
library("readr")
library("dplyr")
library("sf")
library("ggplot2")
library("lubridate")
library("SimilarityMeasures")
```

#Preparation

```{r Task 0.1}
wildschwein <- read_delim("Data/wildschwein_BE_2056.csv", ",")

# Careful! What Timezone is assumed?
sabi <- wildschwein |>
    st_as_sf(coords = c("E", "N"), crs = 2056, remove = FALSE) |>
    filter(TierName == "Sabi", DatetimeUTC >= "2015-07-01", DatetimeUTC < "2015-07-03")
```

```{r Task 0.2}
ggplot(sabi, aes(E, N, color=DatetimeUTC)) +
  geom_point() +
  geom_path() +
  coord_fixed() +
  scale_color_datetime(low="blue", high="red") +
  guides(color = guide_colorbar(title.position="top", title.hjust=.5, barwidth = unit(20, "lines"), barheight = unit(.5, "lines"))) +
  theme(legend.position = "bottom") +
  geom_point (y = 1205120, x = 2570470, size = 20, pch = 21, color = "black", stroke = 4)
```

```{r Task 0.3}
#steb a/b
distance_by_element <- function(later,now) {
  as.numeric(
    st_distance(later, now, by_element = TRUE)
    )
}

sabi <- sabi |>
    mutate(
        nMinus2 = distance_by_element(lag(geometry, 2), geometry),  # distance to pos -30 minutes
        nMinus1 = distance_by_element(lag(geometry, 1), geometry),  # distance to pos -15 minutes
        nPlus1  = distance_by_element(geometry, lead(geometry, 1)), # distance to pos +15 mintues
        nPlus2  = distance_by_element(geometry, lead(geometry, 2))  # distance to pos +30 minutes
    )
```

```{r Task 0.4}
sabi <- sabi |>
    rowwise() |>
    mutate(
        stepMean = mean(c(nMinus2, nMinus1, nPlus1, nPlus2))
    ) |>
    ungroup()

sabi
```

```{r Task 0.5}
sabi <- sabi |>
    mutate(static = stepMean < mean(stepMean, na.rm = TRUE))

sabi_filter <- sabi |>
    filter(!static)

sabi_filter |>
    ggplot(aes(E, N)) +
    geom_path() +
    geom_point() +
    coord_fixed() +
    theme(legend.position = "bottom")
```

#Task 1

```{r Task 1.1}
# Import GPX data
gpx_path <- "Data/Jogging 3.gpx"
gpx_data <- st_read(gpx_path, layer = "track_points") 

# Convert time to POSIXct format
gpx_data$time <- ymd_hms(gpx_data$time)

# Transform to LV95 (EPSG:2056)
gpx_lv95 <- st_transform(gpx_data, crs = 2056)
```

```{r Task 1.2}
ggplot(gpx_lv95, aes(x = st_coordinates(gpx_lv95)[, 1], y = st_coordinates(gpx_lv95)[, 2], color = time)) +
  geom_point() +
  geom_path() +
  coord_fixed() +
  scale_color_datetime(low="blue", high="red") +
  guides(color = guide_colorbar(title.position="top", title.hjust=.5, barwidth = unit(20, "lines"), barheight = unit(.5, "lines"))) +
  theme(legend.position = "bottom")
```

#Task 2

```{r Task 2.1}
distance_by_element <- function(later, now) {
  as.numeric(
    st_distance(later, now, by_element = TRUE)
  )
}

gpx_lv95 <- gpx_lv95 |>
    mutate(
        nMinus2 = distance_by_element(lag(geometry, 2), geometry),  # distance to pos -30 minutes
        nMinus1 = distance_by_element(lag(geometry, 1), geometry),  # distance to pos -15 minutes
        nPlus1  = distance_by_element(geometry, lead(geometry, 1)), # distance to pos +15 mintues
        nPlus2  = distance_by_element(geometry, lead(geometry, 2))  # distance to pos +30 minutes
    )

gpx_lv95 <- gpx_lv95 |>
    rowwise() |>
    mutate(
        stepMean = mean(c(nMinus2, nMinus1, nPlus1, nPlus2))
    ) |>
    ungroup()
```

```{r Task 2.2}
summary(gpx_lv95$stepMean)
boxplot(gpx_lv95$stepMean)

#The threshold of 5.130 is used to differentiate between stops and moves
threshold = 5.130

gpx_lv95 <- gpx_lv95 %>%
  mutate(static = ifelse(stepMean < threshold, TRUE, FALSE))

# Replace NA values in the 'static' column with FALSE for the first row
gpx_lv95$static[is.na(gpx_lv95$static)] <- FALSE
```

#Task 3

```{r Task 3.1}
ggplot(gpx_lv95, aes(x = st_coordinates(gpx_lv95)[, 1], y = st_coordinates(gpx_lv95)[, 2], color = static)) +
  geom_point() +
  geom_path() +
  coord_fixed()
```

#Task 4

```{r Task 4.1}
rle_id <- function(vec) {
    x <- rle(vec)$lengths
    as.factor(rep(seq_along(x), times = x))
}

gpx_lv95 <- gpx_lv95 |>
    mutate(segment_id = rle_id(static))
```

#Task 5

```{r Task 5.1}
# Read the CSV file
pedestrian_data <- read_csv("Data/pedestrian.csv")

# Check the structure of the dataset
str(pedestrian_data)

# Plot the trajectories
ggplot(pedestrian_data, aes(x = E, y = N, color = factor(TrajID))) +
  geom_point() +
  geom_path() +
  facet_wrap(~ TrajID) +
  coord_fixed() +
  labs(title = "Visual comparison of the 6 trajectories",
       subtitle = "Each subplot highlights a trajectory",
       x = "X",
       y = "Y",
       color = "TrajID") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

#Task 6

```{r Task 6.1}
# Convert the data to matrices, one trajectory per matrix
trajectory_list <- pedestrian_data %>%
  group_by(TrajID) %>%
  group_split() %>%
  lapply(function(df) as.matrix(df[, c("E", "N")]))

# Extract trajectory 1
traj1 <- trajectory_list[[1]]

# Calculate similarity measures
similarities <- data.frame(
  Trajectory = 2:6,
  DTW = sapply(2:6, function(i) DTW(traj1, trajectory_list[[i]])),
  EditDist = sapply(2:6, function(i) EditDist(traj1, trajectory_list[[i]])),
  Frechet = sapply(2:6, function(i) Frechet(traj1, trajectory_list[[i]])),
  LCSS = sapply(2:6, function(i) LCSS(traj1, trajectory_list[[i]], pointDistance = 20, errorMarg = 5))
)

# Reshape data for plotting
similarities_long <- similarities %>%
  pivot_longer(cols = -Trajectory, names_to = "Measure", values_to = "Value")
```

```{r Task 6.2}
ggplot(similarities_long, aes(x = factor(Trajectory), y = Value, fill = Measure)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ Measure, scales = "free_y") +
  labs(title = "Computed similarities using different measures between trajectory 1 and other trajectories",
       x = "Comparison trajectory",
       y = "Value") +
  theme_minimal()
```
